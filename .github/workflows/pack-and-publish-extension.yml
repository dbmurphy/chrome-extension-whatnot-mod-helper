name: Pack & Publish Chrome Extension

on:
  push:
    branches: [main]
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  release:
    # Avoid infinite loop when the workflow commits version bumps
    if: |
      github.actor != 'github-actions[bot]' &&
      !contains(github.event.head_commit.message, '[skip ci]')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (with tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine next version (Conventional Commits)
        id: semver
        uses: PaulHatch/semantic-version@v5.4.0
        with:
          tag_prefix: "v"
          major_pattern: "/!:|BREAKING CHANGE:/"
          minor_pattern: "/feat:/"
          version_format: "${major}.${minor}.${patch}"

      - name: Update manifest.json version
        if: steps.semver.outputs.version_type != 'none'
        run: |
          chmod +x scripts/set-version.sh
          scripts/set-version.sh "${{ steps.semver.outputs.version }}"

      - name: Commit version bump
        if: steps.semver.outputs.version_type != 'none'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(release): v${{ steps.semver.outputs.version }} [skip ci]"
          file_pattern: manifest.json

      - name: Read HEAD SHA (after commit)
        if: steps.semver.outputs.version_type != 'none'
        id: head
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('node:child_process');
            const sha = execSync('git rev-parse HEAD').toString().trim();
            core.setOutput('sha', sha);

      - name: Create tag vX.Y.Z
        if: steps.semver.outputs.version_type != 'none'
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ steps.semver.outputs.version_tag }}';
            const sha = '${{ steps.head.outputs.sha }}';

            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tag}`,
                sha
              });
              core.info(`Created tag ${tag} -> ${sha}`);
            } catch (e) {
              if (e.status === 422) {
                core.info(`Tag ${tag} already exists; continuing.`);
              } else {
                throw e;
              }
            }

      - name: Zip extension (no bash)
        if: steps.semver.outputs.version_type != 'none'
        uses: TheDoctor0/zip-release@0.7.6
        with:
          type: "zip"
          filename: "chrome-extension-${{ steps.semver.outputs.version_tag }}.zip"
          exclusions: "*.git* /*node_modules/* *.github/* dist/* *.md"

      - name: Create GitHub Release + attach zip
        if: steps.semver.outputs.version_type != 'none'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.semver.outputs.version_tag }}
          files: chrome-extension-${{ steps.semver.outputs.version_tag }}.zip
